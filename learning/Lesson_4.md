# Урок 4 — RPC и WebSocket: как клиент общается с цепочкой

---

## 1. Введение

Для того чтобы приложение могло взаимодействовать с сетью Solana, нужен канал связи между клиентом (например, твоей программой на Python) и узлом блокчейна (валидатором).
Solana предоставляет два способа общения с сетью:

RPC (Remote Procedure Call) — выполняет единичные запросы (например, узнать баланс или отправить транзакцию);

WebSocket — позволяет получать уведомления в реальном времени (например, о новых блоках или изменении аккаунта).

Эти два подхода дополняют друг друга: RPC используется для прямых запросов, WebSocket — для постоянного получения событий.

---

## 2. Что такое RPC

**RPC (Remote Procedure Call)** — это стандартный способ обмена данными между клиентом и сетью.  
Через RPC клиент может:

- узнать баланс аккаунта;
- получить информацию о транзакциях;
- отправить транзакцию;
- запросить состояние блокчейна.

Каждый RPC-запрос выполняется **один раз** и возвращает результат.  
Это похоже на обращение к веб-API: клиент делает запрос → получает ответ.

---

### 2.1. Пример RPC-запроса на Python

Используем код из [`examples/Python/L4-RPC.py`](../examples/Python/L4-RPC.py):

```python
from solana.rpc.api import Client
from solders.pubkey import Pubkey

# Подключаемся к Devnet RPC
client = Client("https://api.devnet.solana.com")

# Адрес аккаунта системной программы
address = Pubkey.from_string("11111111111111111111111111111111")

# Получаем баланс аккаунта
balance = client.get_balance(address)
print("Баланс:", balance.value, "lamports")

# Получаем высоту текущего блока
block_height = client.get_block_height()
print("Высота текущего блока:", block_height.value)
```

**Результат (пример):**
```
Баланс: 1 lamports
Высота текущего блока: 404288980
```

---

## 3. Что такое WebSocket

**WebSocket** — это другой способ связи, который не требует постоянных запросов.  
Когда клиент подключается по WebSocket, между ним и узлом создаётся **постоянное соединение**, и узел может **сам присылать уведомления**.

Это удобно, когда нужно отслеживать события:
- новые блоки (слоты);
- изменение баланса аккаунта;
- подтверждение транзакции.

WebSocket можно сравнить с подпиской: один раз подключился — и получаешь обновления, как в реальном времени.

---

### 3.1. Пример WebSocket-подписки

Используем код из [`examples/Python/L4-WebSocket.py`](../examples/Python/L4-WebSocket.py):

```python
import asyncio
from solana.rpc.websocket_api import connect

async def main():
    async with connect("wss://api.devnet.solana.com/") as websocket:
        print("Подключено к WebSocket RPC")
        # Подписка на уведомления о новых слотах
        await websocket.slot_subscribe()

        # Получаем 5 уведомлений и выходим
        for _ in range(5):
            message = await websocket.recv()
            print("Новое событие:", message)

asyncio.run(main())
```

**Результат (пример):**
```
Подключено к WebSocket RPC
Новое событие: [SubscriptionResult {
    jsonrpc: TwoPointOh,
    id: 1,
    result: 7516,
}]
Новое событие: [SlotNotification {
    result: SlotInfo(
        SlotInfo {
            slot: 416354707,
            parent: 416354706,
            root: 416354675,
        },
    ),
    subscription: 7516,
}]
...
```

**Что происходит:**
- Клиент устанавливает постоянное соединение с RPC-узлом;
- Подписывается на событие (например, новые слоты);
- Получает обновления автоматически без дополнительных запросов.

> WebSocket не подходит для одноразовых запросов — он эффективен, когда нужно получать поток событий.

> В реальных приложениях Solana dApp всегда комбинируют оба подхода:
RPC используется для начальной загрузки данных, а WebSocket — для мгновенного обновления состояния без повторных запросов.


---

## 4. Схема взаимодействия

```
+-------------------+           +-------------------+
|      Клиент       |           |     RPC-узел      |
|                   |           | (Solana endpoint) |
+-----+--+--+-------+           +--------+----+-----+
      |  |  |                            |    |
      |  |  | RPC-запрос (balance, slot) |    |
      |  |  +--------------------------->|    |
      |  |                               |    |
      |  |            RPC-ответ          |    |
      |  |<------------------------------+    |
      |                                       |
      |         WebSocket-подписка            |
      +-------------------------------------->|
      |                                       |
      |     Уведомления в реальном времени    |
      |<--------------------------------------+
```
**Главное различие:**
- RPC — запрос/ответ по требованию.
- WebSocket — постоянный поток данных.

---

## 5. Когда использовать RPC и WebSocket

| Задача | Что использовать | Почему |
|---------|------------------|---------|
| Получить баланс | RPC | Однократный запрос данных |
| Проверить статус транзакции | RPC | Запрос по `signature` |
| Следить за новыми блоками | WebSocket | Поток уведомлений без задержки |
| Реагировать на изменение аккаунта | WebSocket | Реальное время |

> На практике оба механизма работают вместе: RPC отвечает за состояние, WebSocket — за динамику.

---

## 6. Возможные проблемы и поведение сети

- Если RPC недоступен, приложение не сможет выполнять запросы — нужно иметь резервный RPC endpoint.  
- WebSocket может временно терять соединение — при этом нужно переподключаться.  
- Некоторые RPC-сервера ограничивают частоту запросов; WebSocket снижает нагрузку, потому что обновления приходят автоматически.

---

## 7. Вопросы для самопроверки

1. В чём ключевое отличие RPC от WebSocket?  
2. Почему WebSocket не подходит для разовых запросов?  
3. Что происходит при подписке на события аккаунта?  
4. Что делает клиент, если RPC-сервер перестаёт отвечать?  
5. Почему в реальных dApp используется и RPC, и WebSocket одновременно?

---

## 8. Навигация

[← Урок 3 — Devnet / Testnet / Mainnet: когда и зачем использовать каждую сеть](Lesson_3.md)  
[→ Урок 5 — solana-cli: основные команды (keygen, airdrop, balance, transfer)](Lesson_5.md)